{"version":3,"sources":["EditControl.es6"],"names":["define","$","Icons","Modal","AreaEditor","FormEngineValidation","EditControl","_classCallCheck","this","_defineProperty","initializeTrigger","_createClass","key","value","off","on","triggerHandler","bind","event","preventDefault","trigger","currentTarget","show","_this","modalTitle","data","buttonAddrectText","buttonAddcircleText","buttonAddpolyText","buttonDismissText","buttonSaveText","wizardUri","payload","initWizardModal","initialize","getIcon","sizes","default","markupIdentifiers","inline","done","icon","currentModal","advanced","additionalCssClasses","buttons","btnClass","text","callback","post","url","response","find","append","addClass","content","size","full","style","styles","dark","title","destroy","options","backdrop","_this2","image","configuration","scaleFactor","width","parseInt","css","height","editorOptions","canvas","top","browseLinkUrlAjaxUrl","window","TYPO3","settings","ajaxUrls","imagemap_browselink_url","buttonAddRect","buttonAddRectHandler","buttonAddCircle","buttonAddCircleHandler","buttonAddPoly","buttonAddPolyHandler","buttonDismiss","buttonDismissHandler","buttonSave","buttonSaveHandler","areaEditor","setScale","that","$magnify","$zoomOut","$zoomIn","removeClass","click","hide","initializeAreas","existingAreas","stopPropagation","addRect","coords","addCircle","addPoly","modal","hiddenField","concat","itemName","val","toAreaXml","markFieldAsChanged"],"mappings":"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","file":"EditControl.js","sourcesContent":["define([\n\t'jquery',\n\t'TYPO3/CMS/Backend/Icons',\n\t'TYPO3/CMS/Backend/Modal',\n\t'./AreaEditor',\n\t'TYPO3/CMS/Backend/FormEngineValidation',\n\t'jquery-ui/draggable'\n], ($, Icons, Modal, AreaEditor, FormEngineValidation) => {\n\t'use strict';\n\n\tclass EditControl {\n\t\t/**\n\t\t * @type {jQuery}\n\t\t */\n\t\ttrigger = null;\n\n\t\t/**\n\t\t * @type {jQuery}\n\t\t */\n\t\tcurrentModal = null;\n\n\t\t/**\n\t\t * @type {AreaEditor}\n\t\t */\n\t\tareaEditor = null;\n\n\t\t/**\n\t\t * @type {jQuery}\n\t\t */\n\t\timage = null;\n\n\t\t/**\n\t\t * @type {jQuery}\n\t\t */\n\t\tbuttonAddRect = null;\n\n\t\t/**\n\t\t * @type {jQuery}\n\t\t */\n\t\tbuttonAddCircle = null;\n\n\t\t/**\n\t\t * @type {jQuery}\n\t\t */\n\t\tbuttonAddPoly = null;\n\n\t\t/**\n\t\t * @type {jQuery}\n\t\t */\n\t\tbuttonDismiss = null;\n\n\t\t/**\n\t\t * @type {jQuery}\n\t\t */\n\t\tbuttonSave = null;\n\n\t\t/**\n\t\t * @type {object}\n\t\t */\n\t\tconfiguration = null;\n\n\t\tconstructor() {\n\t\t\tthis.initializeTrigger();\n\t\t}\n\n\t\tinitializeTrigger() {\n\t\t\t$('.t3js-area-wizard-trigger').off('click').on('click', this.triggerHandler.bind(this));\n\t\t}\n\n\t\ttriggerHandler(event) {\n\t\t\tevent.preventDefault();\n\t\t\tthis.trigger = $(event.currentTarget);\n\t\t\tthis.show();\n\t\t}\n\n\t\tshow() {\n\t\t\tlet modalTitle = this.trigger.data('modalTitle'),\n\t\t\t\tbuttonAddrectText = this.trigger.data('buttonAddrectText'),\n\t\t\t\tbuttonAddcircleText = this.trigger.data('buttonAddcircleText'),\n\t\t\t\tbuttonAddpolyText = this.trigger.data('buttonAddpolyText'),\n\t\t\t\tbuttonDismissText = this.trigger.data('buttonDismissText'),\n\t\t\t\tbuttonSaveText = this.trigger.data('buttonSaveText'),\n\t\t\t\twizardUri = this.trigger.data('url'),\n\t\t\t\tpayload = this.trigger.data('payload'),\n\t\t\t\tinitWizardModal = this.initialize.bind(this);\n\n\t\t\tIcons.getIcon('spinner-circle', Icons.sizes.default, null, null, Icons.markupIdentifiers.inline).done((icon) => {\n\t\t\t\t/**\n\t\t\t\t * Open modal with areas to edit\n\t\t\t\t */\n\t\t\t\tthis.currentModal = Modal.advanced({\n\t\t\t\t\tadditionalCssClasses: ['modal-area-wizard'],\n\t\t\t\t\tbuttons: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tbtnClass: 'btn-default pull-left button-add-rect',\n\t\t\t\t\t\t\ticon: 'extensions-imagemap-rect',\n\t\t\t\t\t\t\ttext: buttonAddrectText,\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tbtnClass: 'btn-default pull-left button-add-circle',\n\t\t\t\t\t\t\ticon: 'extensions-imagemap-circle',\n\t\t\t\t\t\t\ttext: buttonAddcircleText,\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tbtnClass: 'btn-default pull-left button-add-poly',\n\t\t\t\t\t\t\ticon: 'extensions-imagemap-poly',\n\t\t\t\t\t\t\ttext: buttonAddpolyText,\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tbtnClass: 'btn-default button-dismiss',\n\t\t\t\t\t\t\ticon: 'actions-close',\n\t\t\t\t\t\t\ttext: buttonDismissText,\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tbtnClass: 'btn-primary button-save',\n\t\t\t\t\t\t\ticon: 'actions-document-save',\n\t\t\t\t\t\t\ttext: buttonSaveText,\n\t\t\t\t\t\t},\n\t\t\t\t\t],\n\t\t\t\t\tcallback: (currentModal) => {\n\t\t\t\t\t\t$.post({\n\t\t\t\t\t\t\turl: wizardUri,\n\t\t\t\t\t\t\tdata: payload\n\t\t\t\t\t\t}).done((response) => {\n\t\t\t\t\t\t\tcurrentModal.find('.t3js-modal-body').append(response).addClass('area-editor');\n\t\t\t\t\t\t\tinitWizardModal();\n\t\t\t\t\t\t});\n\t\t\t\t\t},\n\t\t\t\t\tcontent: $('<div class=\"modal-loading\">').append(icon),\n\t\t\t\t\tsize: Modal.sizes.full,\n\t\t\t\t\tstyle: Modal.styles.dark,\n\t\t\t\t\ttitle: modalTitle,\n\t\t\t\t});\n\n\t\t\t\tthis.currentModal.on('hide.bs.modal', () => {\n\t\t\t\t\tthis.destroy();\n\t\t\t\t});\n\t\t\t\t// do not dismiss the modal when clicking beside it to avoid data loss\n\t\t\t\tthis.currentModal.data('bs.modal').options.backdrop = 'static';\n\t\t\t});\n\t\t}\n\n\t\tinitialize() {\n\t\t\tthis.image = this.currentModal.find('.image img');\n\t\t\tthis.configuration = this.currentModal.find('.picture').data('configuration');\n\n\t\t\tlet scaleFactor = this.currentModal.find('.picture').data('scale-factor'),\n\t\t\t\twidth = parseInt(this.image.css('width')),\n\t\t\t\theight = parseInt(this.image.css('height')),\n\t\t\t\teditorOptions = {\n\t\t\t\t\tcanvas: {\n\t\t\t\t\t\twidth: width,\n\t\t\t\t\t\theight: height,\n\t\t\t\t\t\ttop: height * -1,\n\t\t\t\t\t},\n\t\t\t\t\tbrowseLinkUrlAjaxUrl: window.TYPO3.settings.ajaxUrls.imagemap_browselink_url\n\t\t\t\t};\n\n\t\t\tthis.buttonAddRect = this.currentModal.find('.button-add-rect').off('click').on('click', this.buttonAddRectHandler.bind(this));\n\t\t\tthis.buttonAddCircle = this.currentModal.find('.button-add-circle').off('click').on('click', this.buttonAddCircleHandler.bind(this));\n\t\t\tthis.buttonAddPoly = this.currentModal.find('.button-add-poly').off('click').on('click', this.buttonAddPolyHandler.bind(this));\n\t\t\tthis.buttonDismiss = this.currentModal.find('.button-dismiss').off('click').on('click', this.buttonDismissHandler.bind(this));\n\t\t\tthis.buttonSave = this.currentModal.find('.button-save').off('click').on('click', this.buttonSaveHandler.bind(this));\n\n\t\t\tthis.areaEditor = new AreaEditor(editorOptions, 'modal-canvas', '#areasForm');\n\n\t\t\t((scaleFactor) => {\n\t\t\t\tthis.areaEditor.setScale(scaleFactor);\n\n\t\t\t\tlet that = this,\n\t\t\t\t\t$magnify = $('#magnify'),\n\t\t\t\t\t$zoomOut = $magnify.find('.zoomout'),\n\t\t\t\t\t$zoomIn = $magnify.find('.zoomin');\n\n\t\t\t\tif (scaleFactor < 1) {\n\t\t\t\t\t$zoomIn.removeClass('hide');\n\n\t\t\t\t\t$zoomIn.click(() => {\n\t\t\t\t\t\tthat.areaEditor.setScale(1);\n\t\t\t\t\t\t$zoomIn.hide();\n\t\t\t\t\t\t$zoomOut.show();\n\t\t\t\t\t});\n\n\t\t\t\t\t$zoomOut.click(() => {\n\t\t\t\t\t\tthat.areaEditor.setScale(scaleFactor);\n\t\t\t\t\t\t$zoomOut.hide();\n\t\t\t\t\t\t$zoomIn.show();\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t})(scaleFactor);\n\n\t\t\tthis.areaEditor.initializeAreas(this.configuration.existingAreas);\n\t\t}\n\n\t\tdestroy() {\n\t\t\tif (this.currentModal) {\n\t\t\t\tthis.currentModal = null;\n\t\t\t\tthis.areaEditor = null;\n\t\t\t}\n\t\t}\n\n\t\tbuttonAddRectHandler(event) {\n\t\t\tevent.stopPropagation();\n\t\t\tevent.preventDefault();\n\n\t\t\tlet width = parseInt(this.image.css('width')),\n\t\t\t\theight = parseInt(this.image.css('height'));\n\n\t\t\tthis.areaEditor.addRect({\n\t\t\t\tcoords: (width / 2 - 50) + ',' + (height / 2 - 50) + ',' + (width / 2 + 50) + ',' + (height / 2 + 50),\n\t\t\t});\n\t\t}\n\n\t\tbuttonAddCircleHandler(event) {\n\t\t\tevent.stopPropagation();\n\t\t\tevent.preventDefault();\n\n\t\t\tlet width = parseInt(this.image.css('width')),\n\t\t\t\theight = parseInt(this.image.css('height'));\n\n\t\t\tthis.areaEditor.addCircle({\n\t\t\t\tcoords: (width / 2) + ',' + (height / 2) + ',50',\n\t\t\t});\n\t\t}\n\n\t\tbuttonAddPolyHandler(event) {\n\t\t\tevent.stopPropagation();\n\t\t\tevent.preventDefault();\n\n\t\t\tlet width = parseInt(this.image.css('width')),\n\t\t\t\theight = parseInt(this.image.css('height'));\n\n\t\t\tthis.areaEditor.addPoly({\n\t\t\t\tcoords: (width / 2) + ',' + (height / 2 - 50)\n\t\t\t\t\t+ ',' + (width / 2 + 50) + ',' + (height / 2 + 50)\n\t\t\t\t\t+ ',' + (width / 2) + ',' + (height / 2 + 70)\n\t\t\t\t\t+ ',' + (width / 2 - 50) + ',' + (height / 2 + 50)\n\t\t\t});\n\t\t}\n\n\t\tbuttonDismissHandler(event) {\n\t\t\tevent.stopPropagation();\n\t\t\tevent.preventDefault();\n\n\t\t\tthis.currentModal.modal('hide');\n\t\t}\n\n\t\tbuttonSaveHandler(event) {\n\t\t\tevent.stopPropagation();\n\t\t\tevent.preventDefault();\n\n\t\t\tconst hiddenField = $(`input[name=\"${this.configuration.itemName}\"]`);\n\t\t\thiddenField.val(this.areaEditor.toAreaXml()).trigger('imagemap:changed');\n\t\t\tFormEngineValidation.markFieldAsChanged(hiddenField);\n\t\t\tthis.currentModal.modal('hide');\n\t\t}\n\t}\n\n\treturn EditControl;\n});\n"]}